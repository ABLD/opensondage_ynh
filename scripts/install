#!/bin/bash

#=================================================
# GENERIC START
#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source _common.sh
source /usr/share/yunohost/helpers

#=================================================
# MANAGE SCRIPT FAILURE
#=================================================

# Exit if an error occurs during the execution of the script
ynh_abort_if_errors

#=================================================
# RETRIEVE ARGUMENTS FROM THE MANIFEST
#=================================================

app=$YNH_APP_INSTANCE_NAME

# Retrieve arguments
domain=$YNH_APP_ARG_DOMAIN
path=$YNH_APP_ARG_PATH
admin=$YNH_APP_ARG_ADMIN
language=$YNH_APP_ARG_LANGUAGE
is_public=$YNH_APP_ARG_IS_PUBLIC
legal='no'

# Check if admin exists
ynh_user_exists $admin \
    || ynh_die "Wrong admin"

ynh_app_setting_set "$app" admin "$admin"
ynh_app_setting_set "$app" language "$language"
ynh_app_setting_set "$app" legal "$legal"
ynh_app_setting_set "$app" is_public "$is_public"
# Deprecated
ynh_app_setting_set "$app" public_site "$is_public"

# Check domain/path availability
sudo yunohost app checkurl "${domain}${path}" -a "$app" \
    || ynh_die "Path not available: ${domain}${path}"

# Copy files to the right place
final_path=/var/www/$app
sudo mkdir -p $final_path

#=================================================
# DOWNLOAD, CHECK AND UNPACK SOURCE
#=================================================

ynh_app_setting_set "$app" final_path "$final_path"
# Download, check integrity, uncompress and patch the source from app.src
ynh_setup_source "$final_path"

# Generate MySQL password and create database
dbuser=$app
dbname=$app
dbpass=$(ynh_string_random 12)
ynh_app_setting_set "$app" mysqlpwd "$dbpass"
ynh_mysql_create_db "$dbname" "$dbuser" "$dbpass"

config="$final_path/app/inc/config.php"
sudo cp ../conf/config.php $config

# Change variables in configuration
ynh_replace_string "__DBUSER__"    "$dbuser"   $config
ynh_replace_string "__DBPWD__"     "$dbpass"   $config
ynh_replace_string "__DBNAME__"    "$dbname"   $config
ynh_replace_string "__ADMINMAIL__" "$admin"    $config
ynh_replace_string "__LANGUAGE__"  "$language" $config
ynh_replace_string "__DOMAIN__"    "$domain"   $config
ynh_replace_string "__PATH__"      "$path"     $config

cp ../img/logo.png $final_path/images

# Create log file
touch $final_path/admin/stdout.log
sudo chmod 700 $final_path/admin/stdout.log
# Set permissions
sudo chown -R www-data: $final_path

init_composer "www-data" "$final_path"

sudo -u "www-data" php "$final_path/admin/migration.php"

# Modify PHP-FPM pool configuration and copy it to the pool directory
sed -i "s@NAMETOCHANGE@$app@g" ../conf/php-fpm.conf
finalphpconf=/etc/php5/fpm/pool.d/$app.conf
sudo cp ../conf/php-fpm.conf $finalphpconf
sudo chown root: $finalphpconf
sudo chmod 644 $finalphpconf

finalphpini=/etc/php5/fpm/conf.d/20-$app.ini
sudo cp ../conf/php-fpm.ini $finalphpini
sudo chown root: $finalphpini
sudo chmod 644 $finalphpini

# Reload Nginx and regenerate SSOwat conf
sudo service php5-fpm restart

ynh_package_install php-fpdf
sudo yunohost app addaccess $app -u $admin

# Modify Nginx configuration file and copy it to Nginx conf directory
sed -i "s@PATHTOCHANGE@$path@g" ../conf/nginx.conf
sed -i "s@ALIASTOCHANGE@$final_path/@g" ../conf/nginx.conf
sed -i "s@YNH_APP_INSTANCE_NAME@$app@g" ../conf/nginx.conf
sudo cp ../conf/nginx.conf /etc/nginx/conf.d/$domain.d/$app.conf
# Reload Nginx and regenerate SSOwat conf
sudo service nginx reload
ynh_app_setting_set "$app" skipped_uris "/"
if [[ $is_public -eq 0 ]];
then
	ynh_app_setting_set "$app" protected_uris "/admin,/index.php,/choix_date.php,/choix_autre.php,/infos_sondage.php,/scripts"
else
	ynh_app_setting_set "$app" protected_uris "/admin/index.php,/admin/logs_studs.txt,/scripts"
fi
sudo yunohost app ssowatconf
